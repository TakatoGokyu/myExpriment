<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Ÿé¨“ãƒ„ãƒ¼ãƒ« (Excelé€£æºç‰ˆ)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --bg: #f4f6f9;
        }
        body {
            font-family: "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            background: var(--bg);
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 95%;
            max-width: 1000px;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 { margin-top: 0; color: var(--primary); font-size: 1.5rem; }
        
        /* Layout */
        .layout-split { display: flex; gap: 20px; }
        .main-panel { flex: 2; }
        .side-panel { flex: 1; border-left: 1px solid #eee; padding-left: 20px; }

        /* Screens */
        .screen { display: none; }
        .screen.active { display: block; }

        /* UI Elements */
        .config-box { background: #eef2f3; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        select { padding: 8px; font-size: 1rem; width: 100%; margin-bottom: 10px; }
        button {
            background: var(--accent); color: white; border: none;
            padding: 10px 20px; font-size: 1rem; border-radius: 5px; cursor: pointer;
            transition: background 0.2s; width: 100%;
        }
        button:hover { background: #1c6ea4; }
        button.btn-green { background: #27ae60; }
        button.btn-green:hover { background: #219150; }
        button.btn-gray { background: #95a5a6; }

        /* Game Grid */
        .target-box {
            background: #fff3cd; border: 2px solid #ffeeba; color: #856404;
            padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 15px;
        }
        .target-name { font-size: 1.8rem; font-weight: bold; }
        
        .breadcrumbs { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 10px; padding: 5px; background: #fafafa; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
        }
        .item {
            padding: 15px 5px; min-height: 70px;
            border: 1px solid #ddd; border-radius: 6px;
            background: #fff; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
            user-select: none;
        }
        .item:hover { background: #f9f9f9; border-color: #bbb; }
        .item.folder { border-top: 4px solid #f39c12; background: #fffbf0; }
        .item.leaf { border-top: 4px solid #2ecc71; background: #f0fdf4; }
        
        /* History Table */
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        .history-table th, .history-table td { border-bottom: 1px solid #eee; padding: 6px; text-align: left; }
        .history-table th { background: #f8f9fa; color: #666; }
        .history-table tr:first-child td { font-weight: bold; color: var(--accent); } /* Newest entry */

        /* Utility */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: #333; color: #fff; padding: 10px 20px; border-radius: 4px;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

<div class="container layout-split">
    
    <div class="main-panel">
        <h1>å®Ÿé¨“ãƒ„ãƒ¼ãƒ« (Excelé€£æºç‰ˆ)</h1>

        <div id="screen-config" class="screen active">
            <div class="config-box">
                <label><strong>éšå±¤æ·±åº¦ (Depth):</strong></label>
                <select id="depth-select">
                    <option value="1">D=1 (ãƒ•ãƒ©ãƒƒãƒˆ: 256æŠ)</option>
                    <option value="2">D=2 (16ã‚«ãƒ†ã‚´ãƒª Ã— 16)</option>
                    <option value="4">D=4 (4ã‚¸ãƒ£ãƒ³ãƒ« > 4 > 4 > 4)</option>
                    <option value="8">D=8 (è©³ç´°å±æ€§ãƒ„ãƒªãƒ¼)</option>
                </select>
                <p style="font-size:0.8rem; color:#666; margin:5px 0 15px;">
                    â€» å³å´ã®å±¥æ­´ãƒ‘ãƒãƒ«ã«çµæœãŒè“„ç©ã•ã‚Œã¾ã™ã€‚
                </p>
                <button onclick="App.start()">å®Ÿé¨“ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            </div>
        </div>

        <div id="screen-game" class="screen">
            <div class="target-box">
                <div style="font-size:0.8rem;">TARGET</div>
                <div class="target-name" id="target-disp"></div>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <button class="btn-gray" onclick="App.up()" id="btn-back" style="width:auto;">â† æˆ»ã‚‹</button>
                <div class="breadcrumbs" id="breadcrumbs">Top</div>
            </div>

            <div id="grid-area" class="grid"></div>
        </div>

        <div id="screen-result" class="screen">
            <div style="text-align:center; padding: 30px; background:#f8f9fa; border-radius:8px;">
                <h2 style="color:#27ae60; margin:0 0 10px;">å®Ÿé¨“å®Œäº†</h2>
                <div style="font-size:2rem; font-weight:bold; color:#333; margin-bottom:20px;">
                    <span id="res-time"></span> ms
                </div>
                
                <div style="display:grid; gap:10px; max-width:300px; margin:0 auto;">
                    <button class="btn-green" onclick="App.copyResult()">
                        ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼ (Excelç”¨)
                    </button>
                    <button onclick="App.retry()">æ¬¡ã®å®Ÿé¨“ã¸</button>
                    <button class="btn-gray" onclick="App.resetConfig()">è¨­å®šã«æˆ»ã‚‹</button>
                </div>
                <p style="font-size:0.8rem; color:#666; margin-top:10px;">
                    â€»ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦Excelã§è²¼ã‚Šä»˜ã‘(Ctrl+V)ã—ã¦ãã ã•ã„ã€‚<br>
                    å½¢å¼: [æ·±åº¦] [ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ] [æ™‚é–“] [èª¤å›ç­”]
                </p>
            </div>
        </div>
    </div>

    <div class="side-panel">
        <h3>è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿</h3>
        <p style="font-size:0.8rem; color:#666;">ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹ã¾ã§ä¿æŒã•ã‚Œã¾ã™</p>
        
        <table class="history-table">
            <thead>
                <tr>
                    <th>D</th>
                    <th>Time</th>
                    <th>Error</th>
                    <th>Target</th>
                </tr>
            </thead>
            <tbody id="history-body">
                </tbody>
        </table>

        <div style="margin-top:20px;">
            <button class="btn-gray" onclick="App.downloadAllCSV()">ğŸ’¾ ã¾ã¨ã‚ã¦CSVä¿å­˜</button>
        </div>
    </div>
</div>

<div id="toast" class="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>

<script>
/**
 * ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (D=8å¯¾å¿œç‰ˆ)
 */
const Dataset = {
    raw: {
        "å‹•ç‰©": {
            "é™¸ä¸Šãƒ»å¤§å‹": { "è‚‰é£Ÿ": ["ãƒ©ã‚¤ã‚ªãƒ³","ãƒˆãƒ©","ãƒãƒ¼ã‚¿ãƒ¼","ãƒ’ãƒ§ã‚¦"], "è‰é£Ÿ": ["ã‚¾ã‚¦","ã‚­ãƒªãƒ³","ã‚µã‚¤","ã‚«ãƒ"], "ã‚¯ãƒé¡": ["ãƒ’ã‚°ãƒ","ã‚·ãƒ­ã‚¯ãƒ","ãƒ‘ãƒ³ãƒ€","ãƒ„ã‚­ãƒãƒ¯ã‚°ãƒ"], "ã‚¦ãƒé¡": ["ã‚·ãƒã‚¦ãƒ","ã‚¦ãƒ","ãƒ­ãƒ","ãƒãƒ‹ãƒ¼"] },
            "é™¸ä¸Šãƒ»å°å‹": { "ã‚¤ãƒŒç§‘": ["ã‚ªã‚ªã‚«ãƒŸ","ã‚­ãƒ„ãƒ","ã‚¿ãƒŒã‚­","ã‚¤ãƒŒ"], "ã‚µãƒ«ç›®": ["ã‚´ãƒªãƒ©","ãƒãƒ³ãƒ‘ãƒ³ã‚¸ãƒ¼","ãƒ‹ãƒ›ãƒ³ã‚¶ãƒ«","ãƒªã‚¹ã‚¶ãƒ«"], "ã’ã£æ­¯": ["ãƒã‚ºãƒŸ","ãƒªã‚¹","ãƒãƒ ã‚¹ã‚¿ãƒ¼","ã‚«ãƒ”ãƒãƒ©"], "å°å‹•ç‰©": ["ã‚¦ã‚µã‚®","ãƒãƒªãƒã‚ºãƒŸ","ãƒ¢ã‚°ãƒ©","ã‚¹ã‚«ãƒ³ã‚¯"] },
            "æ°´è¾º": { "æµ·ç£": ["ã‚¯ã‚¸ãƒ©","ã‚¤ãƒ«ã‚«","ã‚·ãƒ£ãƒ","ã‚¢ã‚¶ãƒ©ã‚·"], "æ°´è¾º": ["ãƒ¯ãƒ‹","ãƒ“ãƒ¼ãƒãƒ¼","ã‚«ãƒ¯ã‚¦ã‚½","ã‚«ãƒ¢ãƒãƒã‚·"], "æ¥µåœ°": ["ãƒšãƒ³ã‚®ãƒ³","ã‚»ã‚¤ã‚¦ãƒ","ã‚ªãƒƒãƒˆã‚»ã‚¤","ãƒˆãƒ‰"], "é­šé¡": ["ã‚µãƒ¡","ã‚¨ã‚¤","ãƒãƒ³ãƒœã‚¦","ã‚«ãƒ¡"] },
            "ç©º": { "çŒ›ç¦½": ["ãƒ¯ã‚·","ã‚¿ã‚«","ãƒ•ã‚¯ãƒ­ã‚¦","ãƒˆãƒ“"], "é‡é³¥": ["ã‚¹ã‚ºãƒ¡","ã‚«ãƒ©ã‚¹","ãƒãƒˆ","ãƒ„ãƒãƒ¡"], "å®¶ç¦½": ["ãƒ‹ãƒ¯ãƒˆãƒª","ã‚¢ãƒ’ãƒ«","ãƒ€ãƒãƒ§ã‚¦","ã‚¯ã‚¸ãƒ£ã‚¯"], "æ°´é³¥": ["ãƒã‚¯ãƒãƒ§ã‚¦","ã‚«ãƒ¢","ãƒšãƒªã‚«ãƒ³","ãƒ•ãƒ©ãƒŸãƒ³ã‚´"] }
        },
        "é£Ÿã¹ç‰©": {
            "é‡èœ": { "æ ¹èœ": ["ãƒ‹ãƒ³ã‚¸ãƒ³","ãƒ€ã‚¤ã‚³ãƒ³","ã‚¤ãƒ¢","ã‚µãƒ„ãƒã‚¤ãƒ¢"], "è‘‰ç‰©": ["ã‚­ãƒ£ãƒ™ãƒ„","ãƒ¬ã‚¿ã‚¹","ãƒ›ã‚¦ãƒ¬ãƒ³ã‚½ã‚¦","ãƒã‚¯ã‚µã‚¤"], "å®Ÿ": ["ãƒˆãƒãƒˆ","ã‚­ãƒ¥ã‚¦ãƒª","ãƒŠã‚¹","ãƒ”ãƒ¼ãƒãƒ³"], "é¦™": ["ãƒã‚®","ã‚¿ãƒãƒã‚®","ã‚·ãƒ§ã‚¦ã‚¬","ãƒ‹ãƒ³ãƒ‹ã‚¯"] },
            "æœç‰©": { "æŸ‘æ©˜": ["ãƒŸã‚«ãƒ³","ãƒ¬ãƒ¢ãƒ³","ãƒãƒŠãƒŠ","ãƒ‘ã‚¤ãƒ³"], "ãƒãƒ©ç§‘": ["ãƒªãƒ³ã‚´","ãƒŠã‚·","ãƒ¢ãƒ¢","ã‚µã‚¯ãƒ©ãƒ³ãƒœ"], "ãƒ™ãƒªãƒ¼": ["ã‚¤ãƒã‚´","ãƒ–ãƒ‰ã‚¦","ãƒ¡ãƒ­ãƒ³","ã‚¹ã‚¤ã‚«"], "ä»–": ["ã‚­ã‚¦ã‚¤","ã‚«ã‚­","ãƒãƒ³ã‚´ãƒ¼","ã‚¯ãƒª"] },
            "å’Œé£Ÿ": { "é£¯": ["ãŠã«ãã‚Š","ç‚’é£¯","ã‚«ãƒ¬ãƒ¼","ç‰›ä¸¼"], "éºº": ["ãƒ©ãƒ¼ãƒ¡ãƒ³","ã†ã©ã‚“","ãã°","ãƒ‘ã‚¹ã‚¿"], "é­š": ["å¯¿å¸","åˆºèº«","ç„¼ãé­š","å¤©ã·ã‚‰"], "ç²‰": ["ãŠå¥½ã¿ç„¼ã","ãŸã“ç„¼ã","ãƒ‘ãƒ³","ãƒ”ã‚¶"] },
            "æ´‹é£Ÿ": { "è‚‰": ["ã‚¹ãƒ†ãƒ¼ã‚­","ãƒãƒ³ãƒãƒ¼ã‚°","å”æšã’","ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸"], "æ±": ["å‘³å™Œæ±","ã‚¹ãƒ¼ãƒ—","ã‚·ãƒãƒ¥ãƒ¼","ã‚°ãƒ©ã‚¿ãƒ³"], "æ´‹è“": ["ã‚±ãƒ¼ã‚­","ãƒ—ãƒªãƒ³","ã‚¯ãƒƒã‚­ãƒ¼","ãƒ‰ãƒ¼ãƒŠãƒ„"], "å’Œè“": ["å›£å­","å¤§ç¦","ç¾Šç¾¹","ãŸã„ç„¼ã"] }
        },
        "ã‚¹ãƒãƒ¼ãƒ„": {
            "çƒæŠ€": { "ãƒãƒ¼ãƒ ": ["ã‚µãƒƒã‚«ãƒ¼","é‡çƒ","ãƒ©ã‚°ãƒ“ãƒ¼","ã‚¢ãƒ¡ãƒ•ãƒˆ"], "ãƒãƒƒãƒˆ": ["ãƒãƒ¬ãƒ¼","ãƒã‚¹ã‚±","ãƒãƒ³ãƒ‰","ãƒ‰ãƒƒã‚¸"], "ãƒ©ã‚±ãƒƒãƒˆ": ["ãƒ†ãƒ‹ã‚¹","å“çƒ","ãƒãƒ‰","ã‚¹ã‚«ãƒƒã‚·ãƒ¥"], "å€‹äºº": ["ã‚´ãƒ«ãƒ•","ãƒœã‚¦ãƒªãƒ³ã‚°","ãƒ“ãƒªãƒ¤ãƒ¼ãƒ‰","ãƒ€ãƒ¼ãƒ„"] },
            "é™¸ä¸Š": { "èµ°": ["çŸ­è·é›¢","ãƒãƒ©ã‚½ãƒ³","é§…ä¼","ãƒãƒ¼ãƒ‰ãƒ«"], "è·³": ["é«˜è·³ã³","å¹…è·³ã³","æ£’é«˜è·³ã³","ä¸‰æ®µè·³ã³"], "æŠ•": ["ç ²ä¸¸","ã‚„ã‚Š","å††ç›¤","ãƒãƒ³ãƒãƒ¼"], "ä½“æ“": ["ãƒãƒƒãƒˆ","è·³ã³ç®±","é‰„æ£’","æ–°ä½“æ“"] },
            "æ ¼é—˜": { "æ—¥æœ¬": ["æŸ”é“","å‰£é“","ç©ºæ‰‹","ç›¸æ’²"], "æ‰“æ’ƒ": ["ãƒœã‚¯ã‚·ãƒ³ã‚°","ã‚­ãƒƒã‚¯","ãƒ†ã‚³ãƒ³ãƒ‰ãƒ¼","ãƒ ã‚¨ã‚¿ã‚¤"], "çµ„æŠ€": ["ãƒ¬ã‚¹ãƒªãƒ³ã‚°","ã‚µãƒ³ãƒœ","æŸ”è¡“","åˆæ°—é“"], "æ­¦å™¨": ["ãƒ•ã‚§ãƒ³ã‚·ãƒ³ã‚°","ãªããªãŸ","å¼“é“","ã‚¢ãƒ¼ãƒã‚§ãƒªãƒ¼"] },
            "æ°´æ³³": { "æ³³": ["ã‚¯ãƒ­ãƒ¼ãƒ«","å¹³æ³³ã","èƒŒæ³³ã","ãƒã‚¿ãƒ•ãƒ©ã‚¤"], "é›ª": ["ã‚¹ã‚­ãƒ¼","ã‚¹ãƒãƒœ","ã‚¸ãƒ£ãƒ³ãƒ—","ã‚¯ãƒ­ã‚«ãƒ³"], "æ°·": ["ã‚¹ã‚±ãƒ¼ãƒˆ","ãƒ•ã‚£ã‚®ãƒ¥ã‚¢","ãƒ›ãƒƒã‚±ãƒ¼","ã‚«ãƒ¼ãƒªãƒ³ã‚°"], "æ°´": ["ã‚µãƒ¼ãƒ•ã‚£ãƒ³","ãƒ¨ãƒƒãƒˆ","ã‚«ãƒŒãƒ¼","æ°´çƒ"] }
        },
        "æ—¥ç”¨å“": {
            "å®¶å…·": { "å¯": ["æ¤…å­","ã‚½ãƒ•ã‚¡","ãƒ™ãƒƒãƒ‰","åº§å¸ƒå›£"], "æœº": ["ãƒ†ãƒ¼ãƒ–ãƒ«","ãƒ‡ã‚¹ã‚¯","æœ¬æ£š","ã‚¿ãƒ³ã‚¹"], "å…‰": ["è›å…‰ç¯","ãƒ©ã‚¤ãƒˆ","ã‚«ãƒ¼ãƒ†ãƒ³","é¡"], "é£¾": ["æ™‚è¨ˆ","ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼","èŠ±ç“¶","ã‚¯ãƒƒã‚·ãƒ§ãƒ³"] },
            "å®¶é›»": { "å¨": ["å†·è”µåº«","ãƒ¬ãƒ³ã‚¸","ç‚Šé£¯å™¨","ãƒˆãƒ¼ã‚¹ã‚¿ãƒ¼"], "ç”Ÿ": ["æ´—æ¿¯æ©Ÿ","æƒé™¤æ©Ÿ","ã‚¢ã‚¤ãƒ­ãƒ³","ã‚¨ã‚¢ã‚³ãƒ³"], "AV": ["ãƒ†ãƒ¬ãƒ“","ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼","ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³","ã‚«ãƒ¡ãƒ©"], "PC": ["ãƒ‘ã‚½ã‚³ãƒ³","ã‚¹ãƒãƒ›","ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ","ãƒ—ãƒªãƒ³ã‚¿"] },
            "æ–‡å…·": { "æ›¸": ["é‰›ç­†","ãƒšãƒ³","ä¸‡å¹´ç­†","ãƒã‚¸ãƒƒã‚¯"], "æ¶ˆ": ["æ¶ˆã—ã‚´ãƒ ","ãƒã‚µãƒŸ","ã‚«ãƒƒã‚¿ãƒ¼","ä¿®æ­£æ¶²"], "è²¼": ["ã®ã‚Š","ãƒ†ãƒ¼ãƒ—","ãƒ›ãƒƒãƒã‚­ã‚¹","ã‚¯ãƒªãƒƒãƒ—"], "ç´™": ["ãƒãƒ¼ãƒˆ","æ‰‹å¸³","å°ç­’","ãƒ•ã‚¡ã‚¤ãƒ«"] },
            "è¡£é¡": { "ä¸Š": ["Tã‚·ãƒ£ãƒ„","ã‚·ãƒ£ãƒ„","ã‚»ãƒ¼ã‚¿ãƒ¼","ã‚¸ãƒ£ã‚±ãƒƒãƒˆ"], "ä¸‹": ["ã‚ºãƒœãƒ³","ã‚¹ã‚«ãƒ¼ãƒˆ","ã‚¸ãƒ¼ãƒ³ã‚º","çŸ­ãƒ‘ãƒ³"], "é´": ["é´ä¸‹","ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼","ãƒ–ãƒ¼ãƒ„","ã‚µãƒ³ãƒ€ãƒ«"], "å°": ["å¸½å­","æ‰‹è¢‹","ãƒãƒ•ãƒ©ãƒ¼","ãƒ™ãƒ«ãƒˆ"] }
        }
    },
    // D=8ç”¨ã®ãƒ‘ã‚¹ç”Ÿæˆ (çœç•¥ç‰ˆ)
    getDeepPath(g, c, s, items) {
        // ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯: 4ã‚¢ã‚¤ãƒ†ãƒ ã‚’2+2ã«åˆ†å‰²
        return items.map((itm, i) => {
            const l1 = (g=="å‹•ç‰©"||g=="é£Ÿã¹ç‰©") ? "è‡ªç„¶" : "äººå·¥";
            const l7 = (i<2) ? `${items[0]}ãƒ»${items[1]}` : `${items[2]}ãƒ»${items[3]}`;
            return { name: itm, path: [l1, g, c, s, l7] };
        });
    },
    getList() {
        let list = [];
        for(let g in this.raw) for(let c in this.raw[g]) for(let s in this.raw[g][c]) {
            const arr = this.raw[g][c][s];
            const deep = this.getDeepPath(g,c,s,arr);
            deep.forEach(d => list.push({
                name: d.name, path4: [g,c,s], path8: d.path
            }));
        }
        return list;
    }
};

const App = {
    state: {
        history: [], // å…¨ãƒ‡ãƒ¼ã‚¿è“„ç©ç”¨
        depth: 1, items: [], target: null,
        pathStack: [], startTime: 0, endTime: 0, errors: 0
    },

    start() {
        this.state.depth = parseInt(document.getElementById('depth-select').value);
        this.state.items = Dataset.getList();
        this.state.errors = 0;
        this.state.pathStack = [];
        
        const idx = Math.floor(Math.random() * this.state.items.length);
        this.state.target = this.state.items[idx].name;
        
        document.getElementById('target-disp').textContent = this.state.target;
        this.switchScreen('screen-game');
        
        const root = this.buildTree();
        this.enter(root);
        this.state.startTime = performance.now();
    },

    buildTree() {
        const d = this.state.depth;
        const list = this.state.items;
        
        const root = { label: "Top", children: [] };
        
        // D=1: Flat Random
        if(d === 1) {
            const s = [...list].sort(()=>Math.random()-0.5);
            root.children = s.map(i => ({ isLeaf:true, label:i.name }));
            return root;
        }

        // Recursive Builder
        const build = (arr, level, maxL, pKey) => {
            if(level >= maxL) return arr.map(i => ({ isLeaf:true, label:i.name }));
            
            const groups = {};
            arr.forEach(i => {
                let key = "";
                if(d===2) key = `${i.path4[0]}ãƒ»${i.path4[1]}`; // Genre+Cat
                else if(d===4) key = i.path4[level];
                else if(d===8) key = i.path8[level];
                
                if(!groups[key]) groups[key] = [];
                groups[key].push(i);
            });
            
            return Object.keys(groups).map(k => ({
                isLeaf:false, label:k,
                hint: `${groups[k].length}`,
                children: build(groups[k], level+(d===2?10:1), maxL, pKey)
            }));
        };

        // Execution
        let maxL = (d===2)?1 : (d===4)?3 : 5; // D=8ã¯path8[0..4]ã¾ã§
        root.children = build(list, 0, maxL, "");
        return root;
    },

    enter(node) {
        this.state.pathStack.push(node);
        this.render();
    },
    up() {
        if(this.state.pathStack.length > 1) {
            this.state.pathStack.pop();
            this.render();
        }
    },
    render() {
        const cur = this.state.pathStack[this.state.pathStack.length-1];
        const area = document.getElementById('grid-area');
        const crumbs = document.getElementById('breadcrumbs');
        const btn = document.getElementById('btn-back');
        
        crumbs.innerHTML = this.state.pathStack.map(n => `<span style="margin:0 5px;">${n.label.split("ãƒ»")[0]}</span>`).join(">");
        btn.disabled = (this.state.pathStack.length <= 1);
        area.innerHTML = "";
        
        cur.children.forEach(c => {
            const el = document.createElement('div');
            el.className = `item ${c.isLeaf ? 'leaf' : 'folder'}`;
            el.innerHTML = c.isLeaf ? 
                `<strong>${c.label}</strong>` : 
                `<strong>${c.label}</strong><span style="font-size:0.7em;color:#666">(${c.hint})</span>`;
            
            el.onclick = c.isLeaf ? () => this.check(c.label, el) : () => this.enter(c);
            area.appendChild(el);
        });
    },

    check(name, el) {
        if(name === this.state.target) {
            this.finish();
        } else {
            this.state.errors++;
            el.style.borderColor = "red";
            setTimeout(()=>el.style.borderColor="#ddd", 300);
        }
    },

    finish() {
        this.state.endTime = performance.now();
        const time = Math.round(this.state.endTime - this.state.startTime);
        
        // å±¥æ­´ã«è¿½åŠ 
        const result = {
            id: this.state.history.length + 1,
            depth: this.state.depth,
            time: time,
            error: this.state.errors,
            target: this.state.target,
            timestamp: new Date().toLocaleTimeString()
        };
        this.state.history.unshift(result); // å…ˆé ­ã«è¿½åŠ 
        this.updateHistoryUI();

        // çµæœç”»é¢è¡¨ç¤º
        document.getElementById('res-time').textContent = time;
        this.switchScreen('screen-result');
    },

    updateHistoryUI() {
        const tbody = document.getElementById('history-body');
        tbody.innerHTML = this.state.history.map(r => `
            <tr>
                <td>${r.depth}</td>
                <td>${r.time}</td>
                <td>${r.error}</td>
                <td style="font-size:0.8em">${r.target}</td>
            </tr>
        `).join("");
    },

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚¿ãƒ–åŒºåˆ‡ã‚Šã§ã‚³ãƒ”ãƒ¼
    copyResult() {
        const last = this.state.history[0]; // æœ€æ–°
        // Excelç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: æ·±åº¦ [TAB] ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ [TAB] æ™‚é–“ [TAB] ã‚¨ãƒ©ãƒ¼
        const text = `${last.depth}\t${last.target}\t${last.time}\t${last.error}`;
        
        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        });
    },

    retry() { this.start(); }, // åŒã˜è¨­å®šã§å†é–‹
    resetConfig() { this.switchScreen('screen-config'); },

    switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    },

    downloadAllCSV() {
        if(this.state.history.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
        
        // CSVãƒ˜ãƒƒãƒ€
        let csv = "\uFEFFå®Ÿé¨“ID,æ™‚åˆ»,æ·±åº¦(D),ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ,æ™‚é–“(ms),èª¤å›ç­”\n";
        // ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆå¤ã„é †ã«ä¸¦ã¹æ›¿ãˆï¼‰
        [...this.state.history].reverse().forEach(r => {
            csv += `${r.id},${r.timestamp},${r.depth},${r.target},${r.time},${r.error}\n`;
        });

        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `experiment_summary_${new Date().getTime()}.csv`;
        a.click();
    }
};
</script>
</body>
</html>